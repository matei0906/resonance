<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Resonance</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <!-- External font links removed â€” using local fonts: Hyperiot, Nofex, Work Sans (SemiBold & Bold) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Override body background for reset password page */
        body {
            background: transparent !important;
        }
        
        /* Music background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('../assets/images/music.png') center/cover;
            z-index: -1;
            transition: filter 0.3s ease;
        }
        
        [data-theme="dark"] body::before {
            filter: invert(1) hue-rotate(180deg);
        }
        
        #backToLoginBtn:hover {
            background: linear-gradient(135deg, #9b2c1a 0%, #ff8a3d 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(255, 138, 61, 0.35);
        }
        
        /* Reset password card styling */
        .reset-password-card {
            background: #f5f5f5 !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 20px 60px rgba(0, 0, 0, 0.1) !important;
            transition: background-color 0.3s ease, box-shadow 0.3s ease !important;
        }
        
        [data-theme="dark"] .reset-password-card {
            background: var(--card-bg) !important;
            box-shadow: 0 10px 30px var(--shadow-sm), 0 0 30px rgba(255, 138, 61, 0.5), 0 0 60px rgba(255, 138, 61, 0.3) !important;
        }
        
        .reset-password-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 120px 20px 60px;
        }
        
        .reset-password-card {
            max-width: 500px;
            width: 100%;
            padding: 3rem;
            border-radius: 20px;
            position: relative;
            z-index: 1;
        }
        
        .reset-password-card h2 {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 700;
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .reset-password-card p {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .password-wrapper {
            position: relative;
        }
        
        .form-group input {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            width: 100%;
            padding: 0.75rem;
            padding-right: 3rem;
            border: 2px solid var(--border-color-secondary);
            background: var(--bg-secondary);
            border-radius: 8px;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #ff8a3d;
            box-shadow: 0 0 0 3px rgba(255, 138, 61, 0.1);
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: #9b2c1a;
        }
        
        /* Password strength indicator */
        .strength {
            margin-top: 0.5rem;
        }
        
        .strength-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .strength-bar span {
            display: block;
            height: 100%;
            width: 0%;
            transition: all 0.3s ease;
            border-radius: 3px;
        }
        
        .strength-label {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .error-text {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            font-size: 0.875rem;
            color: #dc3545;
            margin-top: 0.5rem;
            display: none;
        }
        
        #resetMessage {
            display: none;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            text-align: center;
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <a href="../index.html" class="logo-link">
                    <img src="../assets/images/resonance.png" alt="Resonance Logo" class="logo-image">
                    <h1 class="logo">Resonance</h1>
                </a>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="../index.html#home" class="nav-link">Home</a></li>
                <li class="nav-item"><a href="../index.html#about" class="nav-link">About</a></li>
                <li class="nav-item"><a href="../index.html#features" class="nav-link">Features</a></li>
                <li class="nav-item"><a href="../index.html#quiz" class="nav-link">Connect</a></li>
            </ul>
            <div class="nav-actions">
                <a href="login.html" class="btn btn-outline" id="backToLoginBtn">Back to Login</a>
                <a href="quiz.html" class="btn btn-primary">Sign Up</a>
            </div>
            <button class="theme-toggle" aria-label="Toggle dark mode">
                <i class="fas fa-moon theme-icon"></i>
            </button>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </nav>
    </header>

    <main class="reset-password-wrapper">
        <div class="reset-password-card">
            <h2>Reset Password</h2>
            <p>Enter your new password below.</p>
            
            <div id="resetMessage"></div>
            
            <form id="resetPasswordForm">
                <div class="form-group">
                    <label for="password">New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" name="password" placeholder="Choose a secure password" required>
                        <button type="button" class="password-toggle" id="togglePassword" aria-label="Toggle password visibility">
                            <i class="fas fa-eye" id="togglePasswordIcon"></i>
                        </button>
                    </div>
                    <div class="strength">
                        <div class="strength-bar"><span id="strengthFill"></span></div>
                        <div class="strength-label" id="strengthLabel">Strength: </div>
                    </div>
                    <div class="error-text" id="passwordError">Password must be at least 8 characters.</div>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Re-enter your password" required>
                        <button type="button" class="password-toggle" id="toggleConfirm" aria-label="Toggle password visibility">
                            <i class="fas fa-eye" id="toggleConfirmIcon"></i>
                        </button>
                    </div>
                    <div class="error-text" id="confirmError">Passwords do not match.</div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-large" id="resetBtn" style="width: 100%; margin-top: 1rem;">Reset Password</button>
            </form>
        </div>
    </main>

    <script src="../assets/js/theme.js"></script>
    <script type="module">
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const resetBtn = document.getElementById('resetBtn');
        const resetMessage = document.getElementById('resetMessage');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const strengthFill = document.getElementById('strengthFill');
        const strengthLabel = document.getElementById('strengthLabel');
        const passwordError = document.getElementById('passwordError');
        const confirmError = document.getElementById('confirmError');

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        // Verify token on page load
        if (!token) {
            showMessage('Invalid reset link. Please request a new password reset.', true);
            resetBtn.disabled = true;
        } else {
            // Verify token is valid
            fetch(`../api/auth/reset-password.php?token=${token}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        showMessage(data.message || 'Invalid or expired reset link.', true);
                        resetBtn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error('Error verifying token:', error);
                    showMessage('Failed to verify reset link. Please try again.', true);
                    resetBtn.disabled = true;
                });
        }

        // Password visibility toggles
        const togglePassword = document.getElementById('togglePassword');
        const togglePasswordIcon = document.getElementById('togglePasswordIcon');
        const toggleConfirm = document.getElementById('toggleConfirm');
        const toggleConfirmIcon = document.getElementById('toggleConfirmIcon');

        togglePassword.addEventListener('click', function() {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;
            togglePasswordIcon.classList.toggle('fa-eye');
            togglePasswordIcon.classList.toggle('fa-eye-slash');
        });

        toggleConfirm.addEventListener('click', function() {
            const type = confirmPasswordInput.type === 'password' ? 'text' : 'password';
            confirmPasswordInput.type = type;
            toggleConfirmIcon.classList.toggle('fa-eye');
            toggleConfirmIcon.classList.toggle('fa-eye-slash');
        });

        // Password strength evaluation
        function evaluatePasswordStrength(password) {
            let score = 0;
            if (!password) return score;

            // Length bonus
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (password.length >= 16) score++;

            // Character variety
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;

            return score;
        }

        function updateStrength() {
            const password = passwordInput.value;
            const score = evaluatePasswordStrength(password);
            let width = 0, color = '', label = '';

            if (score <= 1) {
                width = 20; color = '#dc3545'; label = 'Very Weak';
            } else if (score === 2) {
                width = 40; color = '#ff8c42'; label = 'Weak';
            } else if (score === 3) {
                width = 60; color = '#ffc107'; label = 'Fair';
            } else if (score === 4) {
                width = 80; color = '#8bc34a'; label = 'Good';
            } else if (score >= 5) {
                width = 100; color = '#28a745'; label = 'Strong';
            }

            strengthFill.style.width = width + '%';
            strengthFill.style.background = color;
            strengthLabel.textContent = 'Strength: ' + label;
        }

        passwordInput.addEventListener('input', updateStrength);

        // Clear errors when user starts typing again
        passwordInput.addEventListener('input', () => {
            passwordError.style.display = 'none';
            resetMessage.style.display = 'none';
        });

        confirmPasswordInput.addEventListener('input', () => {
            confirmError.style.display = 'none';
            resetMessage.style.display = 'none';
        });

        function showMessage(message, isError = false) {
            resetMessage.textContent = message;
            resetMessage.style.display = 'block';
            resetMessage.style.backgroundColor = isError ? '#fee' : '#efe';
            resetMessage.style.color = isError ? '#c33' : '#2a7d2a';
            resetMessage.style.border = isError ? '1px solid #fcc' : '1px solid #cfc';
        }

        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            // Check both validations
            const passwordTooShort = password.length < 8;
            const passwordsDontMatch = password !== confirmPassword;
            
            // If both errors exist
            if (passwordTooShort && passwordsDontMatch) {
                // Show length error in top box only
                showMessage('Password must be at least 8 characters long.', true);
                passwordError.style.display = 'none';
                // Show match error in small red text only
                confirmError.style.display = 'block';
                return;
            }
            
            // If only password is too short
            if (passwordTooShort) {
                // Show only in top box
                showMessage('Password must be at least 8 characters long.', true);
                passwordError.style.display = 'none';
                confirmError.style.display = 'none';
                return;
            }
            
            // If only passwords don't match
            if (passwordsDontMatch) {
                // Show only in top box
                showMessage('Passwords do not match.', true);
                passwordError.style.display = 'none';
                confirmError.style.display = 'none';
                return;
            }
            
            // Disable button during submission
            resetBtn.disabled = true;
            resetBtn.textContent = 'Resetting...';
            
            try {
                const response = await fetch('../api/auth/reset-password.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Password reset successful! Redirecting to login...', false);
                    
                    // Redirect to login page after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    showMessage(data.message || 'Failed to reset password. Please try again.', true);
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Reset Password';
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Failed to reset password. Please try again.', true);
                resetBtn.disabled = false;
                resetBtn.textContent = 'Reset Password';
            }
        });
        
        // Enter key support for all inputs
        [passwordInput, confirmPasswordInput].forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    resetPasswordForm.dispatchEvent(new Event('submit'));
                }
            });
        });
    </script>
</body>
</html>
